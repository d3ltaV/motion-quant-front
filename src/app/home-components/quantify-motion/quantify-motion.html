<div class="container">
  <div class="top">
    <div class="upload-section">
      <h3>Upload Video</h3>
      <div class="input-sec">
        <input type="file" #fileInput accept="video/*" (change)="onFileSelected($event)" [disabled]="isUploading()" style="display: none;">
        <button class="upload-btn" matButton="tonal" (click)="fileInput.click()" [disabled]="isUploading()"> Choose Video File </button>
      </div>
      @if (selectedFile()) {
        <div class="file-info">
          <p><strong>Selected:</strong> {{ selectedFile()!.name }}</p>
          <p><strong>Size:</strong> {{ (selectedFile()!.size / 1024 / 1024).toFixed(2) }} MB</p>
        </div>
      }
    </div>

    <div class="algo-section">
      <h3>Processing algorithm</h3>
      <mat-form-field>
        <mat-label>Algorithm</mat-label>
        <mat-select class="motionType" [value]="processAlgo()" (selectionChange)="onProcessAlgoChange($event.value)">
          <mat-option value="Sparse with moving camera">Sparse with attention</mat-option>
          <mat-option value="Dense with moving camera">Dense with attention</mat-option>
          <mat-option value="Sparse without moving camera">Sparse</mat-option>
          <mat-option value="Sparse with bounding box">Sparse with bounding box</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>
  @if (drawBoxSec()) {
    <div class="db">
      <div class="box-type">
        <h3>Create a bounding box</h3>
        <mat-form-field>
          <mat-label>Type of input</mat-label>
          <mat-select class="boxInputType" [value]="boxType()" (selectionChange)="onBoxTypeChange($event.value)">
            <mat-option value="Enter coords">Enter coords</mat-option>
            <mat-option value="Draw box">Draw box</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      @if (enterCoordsSec()) {
        <div class="coords">
          <div class="tc">
            <mat-form-field class="c">
              <mat-label>Top left X</mat-label>
              <input matInput type="number" [value]="parameters().tlx" (input)="onParameterChange('tlx', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
            <mat-form-field class="c">
              <mat-label>Top left Y</mat-label>
              <input matInput type="number" [value]="parameters().tly" (input)="onParameterChange('tly', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
            <mat-form-field class="c">
              <mat-label>Top right X</mat-label>
              <input matInput type="number" [value]="parameters().trx" (input)="onParameterChange('trx', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
            <mat-form-field class="c">
              <mat-label>Top right Y</mat-label>
              <input matInput type="number" [value]="parameters().try" (input)="onParameterChange('try', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
          </div>
          <div class="bc">
            <mat-form-field class="c">
              <mat-label>Bottom left X</mat-label>
              <input matInput type="number" [value]="parameters().blx" (input)="onParameterChange('blx', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
            <mat-form-field class="c">
              <mat-label>Bottom left Y</mat-label>
              <input matInput type="number" [value]="parameters().bly" (input)="onParameterChange('bly', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
            <mat-form-field class="c">
              <mat-label>Bottom right X</mat-label>
              <input matInput type="number" [value]="parameters().brx" (input)="onParameterChange('brx', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
            <mat-form-field class="c">
              <mat-label>Bottom right Y</mat-label>
              <input matInput type="number" [value]="parameters().bry" (input)="onParameterChange('bry', $any($event.target).value)" [disabled]="isUploading()">
            </mat-form-field>
          </div>
        </div>
      } 
      <div class="draw">

      </div>
    </div>
  }
  

  <div class="parameters-section">
    <h3>Processing Parameters</h3>
    <div class="params">
      <div class="zero">
        <div class="sec-z">
          <mat-form-field class="scale">
            <mat-label>Active scale (cm):</mat-label>
            <input matInput type="number" step="0.00001" [value]="parameters().active_scale" (input)="onParameterChange('active_scale', $any($event.target).value)" [disabled]="isUploading()">
          </mat-form-field>
          <p>Physical scale in centimeter of each pixel. Higher resolution means smaller physical scale.</p>
        </div>
        
        <div class="sec-z">
          <mat-form-field class="adjust">
            <mat-label>Adjust for scaling video resolution?</mat-label>
            <mat-select class="adjustOption" [value]="parameters().adjust_for_resolution.toString()" (selectionChange)="onYesNo(($event.value))" [disabled]="isUploading()">
              <mat-option value="false">No</mat-option>
              <mat-option value="true">Yes</mat-option>
            </mat-select>
          </mat-form-field>
          <p>If you do not want to adjust the scaling value based on the scaling video's resolution, select 'No'.</p>
        </div>
      </div>
      
      <div class="one">
        <div class="sec">
          <mat-form-field class="bt">
            <mat-label>Brightness threshold:</mat-label>
            <input matInput type="number" [value]="parameters().brightness_thresh" (input)="onParameterChange('brightness_thresh', $any($event.target).value)" [disabled]="isUploading()">
          </mat-form-field>
          <p>Threshold for considering a pixel intensity change as an event during background segmentation. 
            Recommended range is 0.05-0.3, and minimum is 0 (all pixels trigger events) and maximum is 1 (no pixels trigger events). 
            A higher value is stricter.</p>
        </div>

        <div class="sec">
          <mat-form-field class="et">
            <mat-label>Event threshold (px):</mat-label>
            <input matInput type="number" [value]="parameters().event_thresh" (input)="onParameterChange('event_thresh', $any($event.target).value)" [disabled]="isUploading()">
          </mat-form-field>
          <p>Proportion of frames in which a pixel must exceed brightness threshold to be considered foreground. Range is 0 to 1; if lower, such as 0.2, even changes in a few frames would mark a pixel as important.</p>
        </div>

        <div class="sec">
          <mat-form-field class="n">
            <mat-label>Neighborhood (px):</mat-label>
            <input matInput type="number" [value]="parameters().neighborhood" (input)="onParameterChange('neighborhood', $any($event.target).value)" [disabled]="isUploading()">
          </mat-form-field>
          <p>If a pixel is marked as important, surrounding neighborhood of x pixels is also marked as important.</p>
        </div>
      </div>

      <div class="two">
        <mat-form-field class="rate">
          <mat-label>Frame rate (/s):</mat-label>
          <input matInput type="number" [value]="parameters().frame_rate"  (input)="onParameterChange('frame_rate', $any($event.target).value)"  [disabled]="isUploading()">
        </mat-form-field>
        <mat-form-field class="resolution">
          <mat-label>Resolution</mat-label>
            <mat-select [value]="parameters().resolution.width + 'x' + parameters().resolution.height" (selectionChange)="onResolutionSelect($event.value)" [disabled]="isUploading()">
              <mat-option value="3840x2160">4K (3840x2160)</mat-option>
              <mat-option value="2560x1440">1440p (2560x1440)</mat-option>
              <mat-option value="1920x1080">1080p (1920x1080)</mat-option>
              <mat-option value="1280x720">720p (1280x720)</mat-option>
              <mat-option value="854x480">480p (854x480)</mat-option>
              <mat-option value="640x360">360p (640x360)</mat-option>
            </mat-select>
        </mat-form-field>
        <mat-form-field class="distance">
          <mat-label>Distance to subject (cm):</mat-label>
          <input matInput type="number" [value]="parameters().distance" (input)="onParameterChange('distance',  $any($event.target).value)" [disabled]="isUploading()">
        </mat-form-field>
      </div>
    </div>
    <button matButton="tonal" class="reset-btn" (click)="resetToDefaults()" [disabled]="isUploading()">Reset to Defaults</button>
  </div>
  
  <div class="bottom">
    <button matButton="tonal" class="upload-btn" (click)="upload()" [disabled]="!selectedFile() || isUploading()">
      @if (!isUploading()) {
        <span>Process Video</span>
      } @else {
        <span>Processing...</span>
      }
    </button>
    
    @if (isUploading()) {
      <p class="progress-text">
        @if (processingStatus()) {
          {{ processingStatus() }}
        }
      </p>
    }
  </div>

  @if (errorMessage()) {
    <div class="error-message"> {{ errorMessage() }} </div>
  }
  @if (successMessage()) {
    <div class="success-message"> {{ successMessage() }} </div>
  }
</div>
